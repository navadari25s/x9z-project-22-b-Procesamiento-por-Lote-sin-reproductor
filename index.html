<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armonía Negativa Pro - Procesamiento Profundo</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cargamos @tonejs/midi desde una fuente confiable -->
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #020617;
            min-height: 100vh;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 1rem;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .btn-magic {
            background: linear-gradient(135deg, #4f46e5, #9333ea, #db2777);
            background-size: 200% 200%;
            animation: gradient-anim 4s ease infinite;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes gradient-anim {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }

        /* Estilo para deshabilitar botones */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }
    </style>
</head>
<body>
    <div class="glass-panel w-full max-w-2xl rounded-[2.5rem] p-6 md:p-10 relative overflow-hidden">
        <div class="absolute -top-24 -right-24 w-80 h-80 bg-indigo-600/20 rounded-full blur-[100px]"></div>
        <div class="absolute -bottom-24 -left-24 w-80 h-80 bg-pink-600/20 rounded-full blur-[100px]"></div>
        
        <div class="text-center mb-8 relative z-10">
            <h1 class="text-4xl md:text-5xl font-black mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-300 to-pink-400 tracking-tight">
                Armonía Negativa <span class="text-xs align-middle bg-white/10 border border-white/20 text-white px-2 py-1 rounded-md ml-1">BATCH</span>
            </h1>
            <p class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.4em]">Procesamiento Completo en Lote</p>
        </div>

        <div id="status-area" class="mb-6 text-center h-6 text-xs font-semibold text-indigo-300"></div>

        <!-- PASO 1: SUBIDA -->
        <div id="step-1" class="relative z-10">
            <input type="file" id="midi-input" accept=".mid,.midi" multiple class="hidden">
            <label for="midi-input" class="cursor-pointer flex flex-col items-center justify-center border-2 border-dashed border-white/10 rounded-3xl p-12 group transition-all hover:border-indigo-500/40 hover:bg-indigo-500/5">
                <div class="w-20 h-20 bg-indigo-500/10 rounded-2xl flex items-center justify-center mb-5 group-hover:scale-110 transition-transform duration-500">
                    <i class="fas fa-file-audio text-3xl text-indigo-400"></i>
                </div>
                <span class="text-xl font-bold text-slate-200">Subir Archivos MIDI</span>
                <span class="text-xs text-slate-500 mt-3 font-medium text-center">Haz clic o arrastra tus archivos aquí para comenzar el procesamiento</span>
            </label>
        </div>

        <!-- PASO 2: GESTIÓN DE COLA -->
        <div id="step-2" class="hidden relative z-10 flex flex-col min-h-[400px]">
            <div class="flex justify-between items-center mb-4 px-2">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Archivos en Cola</h3>
                <span id="queue-count" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-full border border-white/10">0</span>
            </div>
            
            <div id="file-queue" class="flex-1 overflow-y-auto custom-scrollbar space-y-2.5 pr-3 mb-6 max-h-[300px]"></div>
            
            <div id="processing-progress" class="hidden mb-6 px-2">
                <div class="flex justify-between text-[10px] text-slate-400 mb-2 uppercase font-bold tracking-tighter">
                    <span id="process-label">Analizando...</span>
                    <span id="process-percent">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                    <div id="process-bar" class="bg-gradient-to-r from-indigo-500 to-pink-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="process-all-btn" class="btn-magic col-span-2 py-5 rounded-2xl text-white font-black shadow-xl flex items-center justify-center gap-3">
                    <i class="fas fa-gears"></i> PROCESAR LOTE
                </button>
                <button id="download-zip-btn" class="hidden bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-all shadow-lg">
                    <i class="fas fa-file-zipper"></i> DESCARGAR ZIP
                </button>
                <button id="clear-queue-btn" class="bg-slate-800 hover:bg-slate-700 py-4 rounded-xl text-slate-300 font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-trash"></i> LIMPIAR
                </button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            files: []
        };

        const elements = {
            status: document.getElementById('status-area'),
            fileInput: document.getElementById('midi-input'),
            fileQueue: document.getElementById('file-queue'),
            zipBtn: document.getElementById('download-zip-btn'),
            processBtn: document.getElementById('process-all-btn'),
            progressContainer: document.getElementById('processing-progress'),
            progressBar: document.getElementById('process-bar'),
            progressLabel: document.getElementById('process-label'),
            progressPercent: document.getElementById('process-percent')
        };

        // --- SUBIDA DE ARCHIVOS ---
        elements.fileInput.onchange = async (e) => {
            const uploaded = Array.from(e.target.files);
            if (uploaded.length === 0) return;

            for (const file of uploaded) {
                const buffer = await file.arrayBuffer();
                state.files.push({
                    name: file.name,
                    originalBuffer: buffer,
                    transformedBinary: null,
                    status: 'pending'
                });
            }
            
            updateUI();
            elements.fileInput.value = "";
        };

        function updateUI() {
            if (state.files.length > 0) {
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
                renderQueue();
            } else {
                document.getElementById('step-1').classList.remove('hidden');
                document.getElementById('step-2').classList.add('hidden');
            }
        }

        function renderQueue() {
            elements.fileQueue.innerHTML = '';
            document.getElementById('queue-count').textContent = state.files.length;
            
            state.files.forEach((file, i) => {
                const div = document.createElement('div');
                div.className = "bg-white/5 border border-white/5 rounded-2xl p-4 flex items-center justify-between group hover:bg-white/10 transition-all";
                
                let iconClass = "fa-clock text-slate-600";
                if (file.status === 'done') iconClass = "fa-check-circle text-emerald-400";
                if (file.status === 'error') iconClass = "fa-exclamation-triangle text-rose-500";

                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fas ${iconClass} text-xs"></i>
                        <span class="text-xs font-bold truncate text-slate-300">${file.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="removeFile(${i})" class="w-8 h-8 rounded-lg bg-white/5 text-slate-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-colors">
                            <i class="fas fa-times text-[10px]"></i>
                        </button>
                    </div>
                `;
                elements.fileQueue.appendChild(div);
            });
        }

        // --- LÓGICA DE PROCESAMIENTO ---
        elements.processBtn.onclick = async () => {
            if (state.files.length === 0) return;

            elements.processBtn.disabled = true;
            elements.progressContainer.classList.remove('hidden');
            elements.zipBtn.classList.add('hidden');

            for (let i = 0; i < state.files.length; i++) {
                const pct = Math.floor((i / state.files.length) * 100);
                elements.progressBar.style.width = `${pct}%`;
                elements.progressPercent.textContent = `${pct}%`;
                elements.progressLabel.textContent = `Procesando: ${state.files[i].name}`;
                
                try {
                    await transformMidiFile(i);
                    state.files[i].status = 'done';
                } catch (e) {
                    console.error("Error al procesar:", state.files[i].name, e);
                    state.files[i].status = 'error';
                }
                renderQueue();
            }

            elements.progressBar.style.width = `100%`;
            elements.progressPercent.textContent = `100%`;
            elements.progressLabel.textContent = `Lote Completado`;
            
            elements.processBtn.disabled = false;
            elements.zipBtn.classList.remove('hidden');
            showStatus("✨ PROCESAMIENTO FINALIZADO", "text-emerald-400");
        };

        async function transformMidiFile(index) {
            const file = state.files[index];
            // Aseguramos que cargue el buffer correctamente con ToneJS Midi
            const midi = new Midi(file.originalBuffer);

            // Algoritmo de Armonía Negativa (Eje Do-Sol -> Do-Fa)
            // Inversión sobre el eje central del círculo de quintas
            // En términos de MIDI: El eje es entre Mi3(64) y Mib3(63) aproximadamente,
            // pero una fórmula común es: nota_nueva = (Nota_Eje * 2) - nota_original
            // Para el eje Do-Sol, el centro es 3.5 (entre Mi y Mib).
            
            midi.tracks.forEach(track => {
                // No procesar canales de percusión (usualmente canal 10 / index 9)
                const isPercussion = track.channel === 9 || track.instrument.percussion;
                if (!isPercussion) {
                    track.notes.forEach(note => {
                        // Implementación de inversión de espejo estándar
                        // Eje Do/Sol: El centro es 63.5 (Mib/Mi) para la octava central
                        // Usamos una constante de reflexión: 127 es el máximo, pero para mantener
                        // la tesitura, calculamos la distancia al eje.
                        
                        let invertedMidi = 127 - note.midi; 
                        
                        // Ajuste de octava para que no suene demasiado agudo o grave respecto al original
                        while (invertedMidi > note.midi + 18) invertedMidi -= 12;
                        while (invertedMidi < note.midi - 18) invertedMidi += 12;
                        
                        note.midi = Math.max(0, Math.min(127, invertedMidi));
                    });
                }
            });

            file.transformedBinary = midi.toArray();
        }

        // --- DESCARGA Y LIMPIEZA ---
        elements.zipBtn.onclick = async () => {
            const zip = new JSZip();
            let count = 0;

            state.files.forEach((f) => {
                if (f.status === 'done' && f.transformedBinary) {
                    zip.file(`NEGATIVE_${f.name}`, f.transformedBinary);
                    count++;
                }
            });

            if (count === 0) {
                showStatus("⚠️ NO HAY ARCHIVOS PROCESADOS", "text-amber-400");
                return;
            }

            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = `Batch_Armonia_Negativa_${new Date().getTime()}.zip`;
            link.click();
            URL.revokeObjectURL(link.href);
        };

        window.removeFile = (i) => {
            state.files.splice(i, 1);
            updateUI();
            if (state.files.length === 0) {
                elements.status.textContent = "";
            }
        };

        document.getElementById('clear-queue-btn').onclick = () => {
            state.files = [];
            updateUI();
            elements.zipBtn.classList.add('hidden');
            elements.progressContainer.classList.add('hidden');
            elements.status.textContent = "";
        };

        function showStatus(msg, cls) {
            elements.status.textContent = msg;
            elements.status.className = `mb-6 text-center h-6 text-xs font-semibold transition-all ${cls}`;
        }

        // Drag & Drop support
        const dropZone = document.querySelector('label[for="midi-input"]');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('drop', async (e) => {
            const dt = e.dataTransfer;
            const files = Array.from(dt.files).filter(f => f.name.endsWith('.mid') || f.name.endsWith('.midi'));
            
            for (const file of files) {
                const buffer = await file.arrayBuffer();
                state.files.push({
                    name: file.name,
                    originalBuffer: buffer,
                    transformedBinary: null,
                    status: 'pending'
                });
            }
            updateUI();
        });
    </script>
</body>
</html>